-- =====================================================\n-- Colitalia Real Estate Plugin - Database Schema\n-- Version: 1.5.0\n-- Description: Complete database schema for the plugin\n-- =====================================================\n\n-- =====================================================\n-- MAIN PROPERTIES TABLE\n-- Stores searchable property data and metadata\n-- =====================================================\n\nCREATE TABLE `wp_colitalia_properties` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n  `post_id` bigint(20) NOT NULL COMMENT 'Reference to wp_posts table',\n  `property_type` varchar(50) NOT NULL COMMENT 'Property type (villa, apartment, etc)',\n  `price` decimal(15,2) DEFAULT NULL COMMENT 'Base price per day',\n  `weekly_price` decimal(15,2) DEFAULT NULL COMMENT 'Weekly price',\n  `monthly_price` decimal(15,2) DEFAULT NULL COMMENT 'Monthly price',\n  `max_guests` int(3) DEFAULT NULL COMMENT 'Maximum number of guests',\n  `bedrooms` int(3) DEFAULT NULL COMMENT 'Number of bedrooms',\n  `bathrooms` int(3) DEFAULT NULL COMMENT 'Number of bathrooms',\n  `size_sqm` int(6) DEFAULT NULL COMMENT 'Size in square meters',\n  `location` varchar(255) DEFAULT NULL COMMENT 'Location string',\n  `latitude` decimal(10,8) DEFAULT NULL COMMENT 'GPS latitude',\n  `longitude` decimal(11,8) DEFAULT NULL COMMENT 'GPS longitude',\n  `available_from` date DEFAULT NULL COMMENT 'Available from date',\n  `available_until` date DEFAULT NULL COMMENT 'Available until date',\n  `is_multiproperty` tinyint(1) DEFAULT 0 COMMENT 'Is this a multi-property investment',\n  `status` enum('active','inactive','maintenance','sold') DEFAULT 'active',\n  `featured` tinyint(1) DEFAULT 0 COMMENT 'Featured property flag',\n  `views_count` bigint(20) DEFAULT 0 COMMENT 'Number of views',\n  `created_at` timestamp DEFAULT CURRENT_TIMESTAMP,\n  `updated_at` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `unique_post_id` (`post_id`),\n  KEY `idx_property_type` (`property_type`),\n  KEY `idx_price` (`price`),\n  KEY `idx_location` (`location`),\n  KEY `idx_availability` (`available_from`, `available_until`),\n  KEY `idx_multiproperty` (`is_multiproperty`),\n  KEY `idx_status` (`status`),\n  KEY `idx_featured` (`featured`),\n  KEY `idx_coordinates` (`latitude`, `longitude`),\n  FOREIGN KEY (`post_id`) REFERENCES `wp_posts`(`ID`) ON DELETE CASCADE\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Properties search data and metadata';\n\n-- =====================================================\n-- BOOKINGS TABLE\n-- Stores all booking information\n-- =====================================================\n\nCREATE TABLE `wp_colitalia_bookings` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n  `property_id` bigint(20) NOT NULL COMMENT 'Reference to properties table',\n  `client_id` bigint(20) NOT NULL COMMENT 'Reference to clients table',\n  `booking_code` varchar(20) NOT NULL COMMENT 'Unique booking reference code',\n  `check_in` date NOT NULL COMMENT 'Check-in date',\n  `check_out` date NOT NULL COMMENT 'Check-out date',\n  `guests` int(3) NOT NULL COMMENT 'Number of guests',\n  `adults` int(3) DEFAULT NULL COMMENT 'Number of adults',\n  `children` int(3) DEFAULT NULL COMMENT 'Number of children',\n  `total_price` decimal(15,2) NOT NULL COMMENT 'Total booking price',\n  `base_price` decimal(15,2) NOT NULL COMMENT 'Base accommodation price',\n  `services_price` decimal(15,2) DEFAULT 0 COMMENT 'Additional services price',\n  `taxes_price` decimal(15,2) DEFAULT 0 COMMENT 'Taxes amount',\n  `deposit_amount` decimal(15,2) DEFAULT NULL COMMENT 'Deposit amount paid',\n  `deposit_percentage` decimal(5,2) DEFAULT 30.00 COMMENT 'Deposit percentage',\n  `status` enum('pending','confirmed','paid','cancelled','completed','refunded') DEFAULT 'pending',\n  `payment_status` enum('unpaid','partial','paid','refunded') DEFAULT 'unpaid',\n  `payment_method` varchar(50) DEFAULT NULL COMMENT 'Payment method used',\n  `payment_transaction_id` varchar(100) DEFAULT NULL COMMENT 'Payment gateway transaction ID',\n  `payment_date` timestamp NULL DEFAULT NULL COMMENT 'Payment completion date',\n  `special_requests` text DEFAULT NULL COMMENT 'Customer special requests',\n  `internal_notes` text DEFAULT NULL COMMENT 'Internal staff notes',\n  `cancellation_reason` text DEFAULT NULL COMMENT 'Cancellation reason',\n  `cancelled_at` timestamp NULL DEFAULT NULL COMMENT 'Cancellation date',\n  `confirmed_at` timestamp NULL DEFAULT NULL COMMENT 'Confirmation date',\n  `currency` varchar(3) DEFAULT 'EUR' COMMENT 'Booking currency',\n  `exchange_rate` decimal(10,4) DEFAULT 1.0000 COMMENT 'Exchange rate used',\n  `source` varchar(50) DEFAULT 'website' COMMENT 'Booking source',\n  `expires_at` timestamp NULL DEFAULT NULL COMMENT 'Booking expiration time',\n  `created_at` timestamp DEFAULT CURRENT_TIMESTAMP,\n  `updated_at` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `unique_booking_code` (`booking_code`),\n  KEY `idx_property_id` (`property_id`),\n  KEY `idx_client_id` (`client_id`),\n  KEY `idx_dates` (`check_in`, `check_out`),\n  KEY `idx_status` (`status`),\n  KEY `idx_payment_status` (`payment_status`),\n  KEY `idx_created_date` (`created_at`),\n  KEY `idx_expires_at` (`expires_at`),\n  FOREIGN KEY (`property_id`) REFERENCES `wp_colitalia_properties`(`id`) ON DELETE RESTRICT,\n  FOREIGN KEY (`client_id`) REFERENCES `wp_colitalia_clients`(`id`) ON DELETE RESTRICT\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Booking records and transactions';\n\n-- =====================================================\n-- CLIENTS TABLE\n-- Stores customer information\n-- =====================================================\n\nCREATE TABLE `wp_colitalia_clients` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n  `user_id` bigint(20) DEFAULT NULL COMMENT 'WordPress user ID if registered',\n  `first_name` varchar(100) NOT NULL COMMENT 'Customer first name',\n  `last_name` varchar(100) NOT NULL COMMENT 'Customer last name',\n  `email` varchar(255) NOT NULL COMMENT 'Customer email address',\n  `phone` varchar(30) DEFAULT NULL COMMENT 'Phone number',\n  `mobile` varchar(30) DEFAULT NULL COMMENT 'Mobile number',\n  `address` text DEFAULT NULL COMMENT 'Full address',\n  `address_line_2` varchar(255) DEFAULT NULL COMMENT 'Address line 2',\n  `city` varchar(100) DEFAULT NULL COMMENT 'City',\n  `state_province` varchar(100) DEFAULT NULL COMMENT 'State or Province',\n  `country` varchar(100) DEFAULT NULL COMMENT 'Country',\n  `postal_code` varchar(20) DEFAULT NULL COMMENT 'ZIP/Postal code',\n  `birth_date` date DEFAULT NULL COMMENT 'Date of birth',\n  `nationality` varchar(100) DEFAULT NULL COMMENT 'Nationality',\n  `document_type` varchar(50) DEFAULT NULL COMMENT 'ID document type',\n  `document_number` varchar(100) DEFAULT NULL COMMENT 'ID document number',\n  `document_expiry` date DEFAULT NULL COMMENT 'Document expiry date',\n  `tax_code` varchar(50) DEFAULT NULL COMMENT 'Tax code/SSN',\n  `company_name` varchar(255) DEFAULT NULL COMMENT 'Company name (for business clients)',\n  `vat_number` varchar(50) DEFAULT NULL COMMENT 'VAT/Tax ID number',\n  `language` varchar(10) DEFAULT 'it' COMMENT 'Preferred language',\n  `currency` varchar(3) DEFAULT 'EUR' COMMENT 'Preferred currency',\n  `timezone` varchar(50) DEFAULT NULL COMMENT 'Client timezone',\n  `gdpr_consent` tinyint(1) DEFAULT 0 COMMENT 'GDPR consent given',\n  `gdpr_consent_date` timestamp NULL DEFAULT NULL COMMENT 'GDPR consent date',\n  `marketing_consent` tinyint(1) DEFAULT 0 COMMENT 'Marketing consent given',\n  `marketing_consent_date` timestamp NULL DEFAULT NULL COMMENT 'Marketing consent date',\n  `email_verified` tinyint(1) DEFAULT 0 COMMENT 'Email verification status',\n  `email_verified_at` timestamp NULL DEFAULT NULL COMMENT 'Email verification date',\n  `phone_verified` tinyint(1) DEFAULT 0 COMMENT 'Phone verification status',\n  `status` enum('active','inactive','blocked','deleted') DEFAULT 'active',\n  `notes` text DEFAULT NULL COMMENT 'Internal client notes',\n  `total_bookings` int(11) DEFAULT 0 COMMENT 'Total number of bookings',\n  `total_spent` decimal(15,2) DEFAULT 0 COMMENT 'Total amount spent',\n  `loyalty_points` int(11) DEFAULT 0 COMMENT 'Loyalty program points',\n  `referral_code` varchar(20) DEFAULT NULL COMMENT 'Referral code',\n  `referred_by` bigint(20) DEFAULT NULL COMMENT 'Referred by client ID',\n  `last_login` timestamp NULL DEFAULT NULL COMMENT 'Last login date',\n  `created_at` timestamp DEFAULT CURRENT_TIMESTAMP,\n  `updated_at` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `unique_email` (`email`),\n  UNIQUE KEY `unique_referral_code` (`referral_code`),\n  KEY `idx_user_id` (`user_id`),\n  KEY `idx_full_name` (`first_name`, `last_name`),\n  KEY `idx_city_country` (`city`, `country`),\n  KEY `idx_status` (`status`),\n  KEY `idx_total_bookings` (`total_bookings`),\n  KEY `idx_total_spent` (`total_spent`),\n  KEY `idx_referred_by` (`referred_by`),\n  FOREIGN KEY (`user_id`) REFERENCES `wp_users`(`ID`) ON DELETE SET NULL,\n  FOREIGN KEY (`referred_by`) REFERENCES `wp_colitalia_clients`(`id`) ON DELETE SET NULL\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Customer information and profiles';\n\n-- =====================================================\n-- MULTI-PROPERTY INVESTMENTS TABLE\n-- For timeshare/investment property management\n-- =====================================================\n\nCREATE TABLE `wp_colitalia_multiproperty_investments` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n  `property_id` bigint(20) NOT NULL COMMENT 'Reference to properties table',\n  `owner_id` bigint(20) NOT NULL COMMENT 'Reference to clients table',\n  `investment_amount` decimal(15,2) NOT NULL COMMENT 'Total investment amount',\n  `ownership_percentage` decimal(5,2) NOT NULL COMMENT 'Ownership percentage',\n  `weekly_slots_owned` int(3) NOT NULL COMMENT 'Number of weeks owned per year',\n  `annual_profit_target` decimal(15,2) DEFAULT NULL COMMENT 'Expected annual profit',\n  `actual_annual_profit` decimal(15,2) DEFAULT 0 COMMENT 'Actual profit generated',\n  `management_fee_percentage` decimal(5,2) DEFAULT 10.00 COMMENT 'Management fee percentage',\n  `investment_type` enum('full_ownership','timeshare','fractional','rental_pool') DEFAULT 'timeshare',\n  `contract_start_date` date NOT NULL COMMENT 'Contract start date',\n  `contract_end_date` date DEFAULT NULL COMMENT 'Contract end date',\n  `contract_number` varchar(50) DEFAULT NULL COMMENT 'Legal contract number',\n  `status` enum('active','suspended','terminated','pending') DEFAULT 'pending',\n  `priority_booking` tinyint(1) DEFAULT 0 COMMENT 'Priority booking rights',\n  `usage_weeks_per_year` int(3) DEFAULT 0 COMMENT 'Weeks used personally per year',\n  `rental_weeks_per_year` int(3) DEFAULT 0 COMMENT 'Weeks rented out per year',\n  `last_profit_distribution` decimal(15,2) DEFAULT 0 COMMENT 'Last profit distribution amount',\n  `last_distribution_date` date DEFAULT NULL COMMENT 'Last profit distribution date',\n  `notes` text DEFAULT NULL COMMENT 'Investment notes',\n  `created_at` timestamp DEFAULT CURRENT_TIMESTAMP,\n  `updated_at` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n  PRIMARY KEY (`id`),\n  KEY `idx_property_owner` (`property_id`, `owner_id`),\n  KEY `idx_ownership` (`ownership_percentage`),\n  KEY `idx_status` (`status`),\n  KEY `idx_contract_dates` (`contract_start_date`, `contract_end_date`),\n  FOREIGN KEY (`property_id`) REFERENCES `wp_colitalia_properties`(`id`) ON DELETE CASCADE,\n  FOREIGN KEY (`owner_id`) REFERENCES `wp_colitalia_clients`(`id`) ON DELETE CASCADE\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Multi-property investment records';\n\n-- =====================================================\n-- EMAIL LOGS TABLE\n-- Tracks all email communications\n-- =====================================================\n\nCREATE TABLE `wp_colitalia_email_logs` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n  `recipient` varchar(255) NOT NULL COMMENT 'Email recipient',\n  `sender` varchar(255) DEFAULT NULL COMMENT 'Email sender',\n  `subject` varchar(500) NOT NULL COMMENT 'Email subject',\n  `email_type` varchar(100) NOT NULL COMMENT 'Type of email sent',\n  `template_used` varchar(100) DEFAULT NULL COMMENT 'Email template used',\n  `content_preview` text DEFAULT NULL COMMENT 'First 500 chars of email content',\n  `status` enum('sent','failed','bounced','delivered','opened','clicked') DEFAULT 'sent',\n  `error_message` text DEFAULT NULL COMMENT 'Error message if failed',\n  `booking_id` bigint(20) DEFAULT NULL COMMENT 'Related booking ID',\n  `client_id` bigint(20) DEFAULT NULL COMMENT 'Related client ID',\n  `property_id` bigint(20) DEFAULT NULL COMMENT 'Related property ID',\n  `campaign_id` varchar(50) DEFAULT NULL COMMENT 'Email campaign ID',\n  `message_id` varchar(255) DEFAULT NULL COMMENT 'Email service message ID',\n  `ip_address` varchar(45) DEFAULT NULL COMMENT 'Sender IP address',\n  `user_agent` text DEFAULT NULL COMMENT 'User agent string',\n  `opened_at` timestamp NULL DEFAULT NULL COMMENT 'Email opened timestamp',\n  `clicked_at` timestamp NULL DEFAULT NULL COMMENT 'Link clicked timestamp',\n  `bounced_at` timestamp NULL DEFAULT NULL COMMENT 'Bounce timestamp',\n  `sent_at` timestamp DEFAULT CURRENT_TIMESTAMP,\n  PRIMARY KEY (`id`),\n  KEY `idx_recipient` (`recipient`),\n  KEY `idx_email_type` (`email_type`),\n  KEY `idx_booking_id` (`booking_id`),\n  KEY `idx_client_id` (`client_id`),\n  KEY `idx_status` (`status`),\n  KEY `idx_sent_at` (`sent_at`),\n  KEY `idx_campaign` (`campaign_id`),\n  FOREIGN KEY (`booking_id`) REFERENCES `wp_colitalia_bookings`(`id`) ON DELETE SET NULL,\n  FOREIGN KEY (`client_id`) REFERENCES `wp_colitalia_clients`(`id`) ON DELETE SET NULL,\n  FOREIGN KEY (`property_id`) REFERENCES `wp_colitalia_properties`(`id`) ON DELETE SET NULL\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Email communication logs';\n\n-- =====================================================\n-- PERFORMANCE LOGS TABLE\n-- Tracks system performance and usage\n-- =====================================================\n\nCREATE TABLE `wp_colitalia_performance_logs` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n  `action_type` varchar(50) NOT NULL COMMENT 'Type of action performed',\n  `execution_time` decimal(8,4) NOT NULL COMMENT 'Execution time in seconds',\n  `memory_usage` bigint(20) NOT NULL COMMENT 'Memory usage in bytes',\n  `cpu_usage` decimal(5,2) DEFAULT NULL COMMENT 'CPU usage percentage',\n  `database_queries` int(11) DEFAULT NULL COMMENT 'Number of database queries',\n  `cache_hits` int(11) DEFAULT NULL COMMENT 'Number of cache hits',\n  `cache_misses` int(11) DEFAULT NULL COMMENT 'Number of cache misses',\n  `user_id` bigint(20) DEFAULT NULL COMMENT 'WordPress user ID',\n  `client_id` bigint(20) DEFAULT NULL COMMENT 'Client ID if applicable',\n  `property_id` bigint(20) DEFAULT NULL COMMENT 'Property ID if applicable',\n  `booking_id` bigint(20) DEFAULT NULL COMMENT 'Booking ID if applicable',\n  `ip_address` varchar(45) DEFAULT NULL COMMENT 'User IP address',\n  `user_agent` text DEFAULT NULL COMMENT 'User agent string',\n  `request_uri` varchar(500) DEFAULT NULL COMMENT 'Request URI',\n  `request_method` varchar(10) DEFAULT NULL COMMENT 'HTTP request method',\n  `response_code` int(3) DEFAULT NULL COMMENT 'HTTP response code',\n  `error_message` text DEFAULT NULL COMMENT 'Error message if any',\n  `additional_data` longtext DEFAULT NULL COMMENT 'Additional JSON data',\n  `created_at` timestamp DEFAULT CURRENT_TIMESTAMP,\n  PRIMARY KEY (`id`),\n  KEY `idx_action_type` (`action_type`),\n  KEY `idx_execution_time` (`execution_time`),\n  KEY `idx_created_at` (`created_at`),\n  KEY `idx_user_id` (`user_id`),\n  KEY `idx_response_code` (`response_code`),\n  FOREIGN KEY (`user_id`) REFERENCES `wp_users`(`ID`) ON DELETE SET NULL,\n  FOREIGN KEY (`client_id`) REFERENCES `wp_colitalia_clients`(`id`) ON DELETE SET NULL,\n  FOREIGN KEY (`property_id`) REFERENCES `wp_colitalia_properties`(`id`) ON DELETE SET NULL,\n  FOREIGN KEY (`booking_id`) REFERENCES `wp_colitalia_bookings`(`id`) ON DELETE SET NULL\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='System performance monitoring';\n\n-- =====================================================\n-- SEASONAL PRICING TABLE\n-- Manages seasonal and dynamic pricing\n-- =====================================================\n\nCREATE TABLE `wp_colitalia_seasonal_pricing` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n  `property_id` bigint(20) NOT NULL COMMENT 'Reference to properties table',\n  `season_name` varchar(100) NOT NULL COMMENT 'Season name',\n  `start_date` date NOT NULL COMMENT 'Season start date',\n  `end_date` date NOT NULL COMMENT 'Season end date',\n  `price_per_day` decimal(15,2) NOT NULL COMMENT 'Price per day for this season',\n  `price_per_week` decimal(15,2) DEFAULT NULL COMMENT 'Price per week',\n  `price_per_month` decimal(15,2) DEFAULT NULL COMMENT 'Price per month',\n  `minimum_stay` int(3) DEFAULT 1 COMMENT 'Minimum stay in days',\n  `maximum_stay` int(3) DEFAULT NULL COMMENT 'Maximum stay in days',\n  `priority` int(3) DEFAULT 1 COMMENT 'Priority (higher number = higher priority)',\n  `is_active` tinyint(1) DEFAULT 1 COMMENT 'Is this season active',\n  `created_at` timestamp DEFAULT CURRENT_TIMESTAMP,\n  `updated_at` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n  PRIMARY KEY (`id`),\n  KEY `idx_property_dates` (`property_id`, `start_date`, `end_date`),\n  KEY `idx_priority` (`priority`),\n  KEY `idx_active` (`is_active`),\n  FOREIGN KEY (`property_id`) REFERENCES `wp_colitalia_properties`(`id`) ON DELETE CASCADE\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Seasonal pricing configuration';\n\n-- =====================================================\n-- BOOKING SERVICES TABLE\n-- Additional services for bookings\n-- =====================================================\n\nCREATE TABLE `wp_colitalia_booking_services` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n  `booking_id` bigint(20) NOT NULL COMMENT 'Reference to bookings table',\n  `service_name` varchar(255) NOT NULL COMMENT 'Service name',\n  `service_description` text DEFAULT NULL COMMENT 'Service description',\n  `quantity` int(3) DEFAULT 1 COMMENT 'Service quantity',\n  `unit_price` decimal(15,2) NOT NULL COMMENT 'Price per unit',\n  `total_price` decimal(15,2) NOT NULL COMMENT 'Total price for this service',\n  `is_mandatory` tinyint(1) DEFAULT 0 COMMENT 'Is this service mandatory',\n  `category` varchar(50) DEFAULT 'extra' COMMENT 'Service category',\n  `created_at` timestamp DEFAULT CURRENT_TIMESTAMP,\n  PRIMARY KEY (`id`),\n  KEY `idx_booking_id` (`booking_id`),\n  KEY `idx_category` (`category`),\n  FOREIGN KEY (`booking_id`) REFERENCES `wp_colitalia_bookings`(`id`) ON DELETE CASCADE\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Additional services for bookings';\n\n-- =====================================================\n-- INITIAL DATA INSERTS\n-- Default data for fresh installations\n-- =====================================================\n\n-- Insert default property types (assuming they don't exist)\n-- These will be handled by the WordPress taxonomy system\n\n-- =====================================================\n-- INDEXES FOR PERFORMANCE\n-- Additional performance indexes\n-- =====================================================\n\n-- Composite indexes for common queries\nALTER TABLE `wp_colitalia_bookings` \nADD INDEX `idx_property_status_dates` (`property_id`, `status`, `check_in`, `check_out`);\n\nALTER TABLE `wp_colitalia_properties` \nADD INDEX `idx_type_price_guests` (`property_type`, `price`, `max_guests`);\n\nALTER TABLE `wp_colitalia_clients` \nADD INDEX `idx_status_bookings_spent` (`status`, `total_bookings`, `total_spent`);\n\n-- Full-text search indexes\nALTER TABLE `wp_colitalia_properties` \nADD FULLTEXT(`location`);\n\n-- =====================================================\n-- STORED PROCEDURES (Optional)\n-- Useful procedures for common operations\n-- =====================================================\n\nDELIMITER //\n\n-- Procedure to check property availability\nCREATE PROCEDURE CheckPropertyAvailability(\n    IN p_property_id BIGINT,\n    IN p_check_in DATE,\n    IN p_check_out DATE\n)\nBEGIN\n    SELECT COUNT(*) as conflicts\n    FROM wp_colitalia_bookings\n    WHERE property_id = p_property_id\n    AND status IN ('confirmed', 'paid')\n    AND (\n        (check_in <= p_check_in AND check_out > p_check_in) OR\n        (check_in < p_check_out AND check_out >= p_check_out) OR\n        (check_in >= p_check_in AND check_out <= p_check_out)\n    );\nEND//\n\n-- Procedure to calculate booking price\nCREATE PROCEDURE CalculateBookingPrice(\n    IN p_property_id BIGINT,\n    IN p_check_in DATE,\n    IN p_check_out DATE,\n    OUT p_total_price DECIMAL(15,2)\n)\nBEGIN\n    DECLARE v_base_price DECIMAL(15,2);\n    DECLARE v_days INT;\n    \n    SET v_days = DATEDIFF(p_check_out, p_check_in);\n    \n    -- Get base price from properties table\n    SELECT price INTO v_base_price\n    FROM wp_colitalia_properties\n    WHERE id = p_property_id;\n    \n    -- TODO: Add seasonal pricing logic here\n    \n    SET p_total_price = v_base_price * v_days;\nEND//\n\nDELIMITER ;\n\n-- =====================================================\n-- TRIGGERS (Optional)\n-- Automatic data updates\n-- =====================================================\n\nDELIMITER //\n\n-- Trigger to update client statistics\nCREATE TRIGGER update_client_stats_after_booking\n    AFTER INSERT ON wp_colitalia_bookings\n    FOR EACH ROW\nBEGIN\n    UPDATE wp_colitalia_clients\n    SET total_bookings = total_bookings + 1,\n        total_spent = total_spent + NEW.total_price\n    WHERE id = NEW.client_id;\nEND//\n\n-- Trigger to update property view count\nCREATE TRIGGER update_property_views\n    AFTER INSERT ON wp_colitalia_performance_logs\n    FOR EACH ROW\nBEGIN\n    IF NEW.action_type = 'property_view' AND NEW.property_id IS NOT NULL THEN\n        UPDATE wp_colitalia_properties\n        SET views_count = views_count + 1\n        WHERE id = NEW.property_id;\n    END IF;\nEND//\n\nDELIMITER ;\n\n-- =====================================================\n-- VIEWS (Optional)\n-- Useful views for reporting\n-- =====================================================\n\n-- View for property statistics\nCREATE VIEW vw_property_statistics AS\nSELECT \n    p.id,\n    p.post_id,\n    p.property_type,\n    p.price,\n    p.views_count,\n    COUNT(b.id) as total_bookings,\n    COALESCE(SUM(b.total_price), 0) as total_revenue,\n    COALESCE(AVG(b.total_price), 0) as average_booking_value,\n    MAX(b.created_at) as last_booking_date\nFROM wp_colitalia_properties p\nLEFT JOIN wp_colitalia_bookings b ON p.id = b.property_id\nGROUP BY p.id;\n\n-- View for client statistics\nCREATE VIEW vw_client_statistics AS\nSELECT \n    c.id,\n    c.first_name,\n    c.last_name,\n    c.email,\n    c.total_bookings,\n    c.total_spent,\n    COUNT(b.id) as confirmed_bookings,\n    MAX(b.created_at) as last_booking_date,\n    DATEDIFF(CURDATE(), MAX(b.created_at)) as days_since_last_booking\nFROM wp_colitalia_clients c\nLEFT JOIN wp_colitalia_bookings b ON c.id = b.client_id AND b.status IN ('confirmed', 'paid', 'completed')\nGROUP BY c.id;\n\n-- =====================================================\n-- MAINTENANCE NOTES\n-- =====================================================\n\n/*\nREGULAR MAINTENANCE TASKS:\n\n1. Weekly:\n   - OPTIMIZE TABLE wp_colitalia_performance_logs;\n   - DELETE FROM wp_colitalia_performance_logs WHERE created_at < DATE_SUB(NOW(), INTERVAL 30 DAY);\n\n2. Monthly:\n   - ANALYZE TABLE wp_colitalia_bookings;\n   - ANALYZE TABLE wp_colitalia_properties;\n   - UPDATE statistics tables\n\n3. Quarterly:\n   - Review and archive old booking data\n   - Check for orphaned records\n   - Update indexes if needed\n\n4. Annually:\n   - Full database optimization\n   - Backup verification\n   - Performance analysis\n*/\n\n-- =====================================================\n-- VERSION HISTORY\n-- =====================================================\n\n/*\nv1.0.0 - Initial schema\nv1.1.0 - Added performance logging\nv1.2.0 - Added seasonal pricing\nv1.3.0 - Enhanced client profiles\nv1.4.0 - Added booking services\nv1.5.0 - Performance optimizations and triggers\n*/\n